import groovy.json.JsonOutput 

node ('docker-slave') {

    def app

    stage('Clone repository') {
        /* Let's make sure we have the repository cloned to our workspace */

        checkout scm
    }




    stage('Provision Dev App') {
        /*
         *
         *  */

           withCredentials([string(credentialsId: 'morphauth', variable: 'bearer')]) {
            String morpheusUrl = 'https://sandbox.morpheusdata.com/api/apps'

	    Map<?, ?> postBody = ["app":["id":30,"name":"newtest","description":null,"accountId":54,"account":["id":54,"name":"tcook-demo"],"siteId":489,"dateCreated":"2018-04-09T18:27:50+0000","lastUpdated":"2018-04-09T18:27:50+0000","appContext":"dev","status":"running","instanceCount":2,"containerCount":2,"appTiers":[["tier":["id":12,"name":"App"],"appInstances":[["config":[],"instance":["id":4730,"accountId":54,"instanceType":["id":19,"code":"docker","category":"utility","name":"Docker"],"group":["id":489,"name":"VMware"],"cloud":["id":2,"name":"VMware"],"containers":[1759],"connectionInfo":[["ip":"10.30.20.139","port":10006]],"layout":["id":217,"name":"Single Container","provisionTypeCode":"docker"],"plan":["id":81,"code":"container-256","name":"256MB Memory, 3GB Storage"],"name":"tcook-demo-vmware-docker-11","description":null,"customOptions":[],"instanceVersion":null,"tags":[],"maxMemory":268435456,"maxStorage":3221225472,"maxCores":null,"maxCpu":null,"dateCreated":"2018-04-09T18:27:50+0000","lastUpdated":"2018-04-09T18:27:50+0000","hostName":"tcook-demo-vmware-docker-11","domainName":null,"environmentPrefix":null,"firewallEnabled":true,"networkLevel":"container","autoScale":false,"instanceContext":"dev","currentDeployId":null,"locked":false,"createdBy":["id":122]]]]],["tier":["id":13,"name":"Database"],"appInstances":[["config":[],"instance":["id":4731,"accountId":54,"instanceType":["id":12,"code":"mysql","category":"sql","name":"MySQL"],"group":["id":489,"name":"VMware"],"cloud":["id":2,"name":"VMware"],"containers":[1760],"connectionInfo":[["ip":"10.30.20.139","port":10007]],"layout":["id":90,"name":"Docker Single Master","provisionTypeCode":"docker"],"plan":["id":80,"code":"container-128","name":"128MB Memory, 1GB Storage"],"name":"tcook-demo-vmware-mysql-15","description":null,"customOptions":[],"instanceVersion":null,"tags":[],"maxMemory":134217728,"maxStorage":1073741824,"maxCores":null,"maxCpu":null,"dateCreated":"2018-04-09T18:27:50+0000","lastUpdated":"2018-04-09T18:27:50+0000","hostName":"tcook-demo-vmware-mysql-15","domainName":null,"environmentPrefix":null,"firewallEnabled":true,"networkLevel":"container","autoScale":false,"instanceContext":"dev","currentDeployId":23,"locked":false,"createdBy":["id":122]]]]]]],"containers":[["id":1760,"accountId":54,"instance":["id":4731,"name":"tcook-demo-vmware-mysql-15"],"containerType":["id":90,"code":"mysql-5.7","category":"master","name":"MySQL 5.7"],"containerTypeSet":["id":92,"code":"mysql-5.7-set","category":"master"],"server":["id":9984,"name":"guacdocker"],"cloud":["id":2,"name":"VMware"],"name":"tcook-demo-vmware-mysql-15_1760","ip":"10.30.20.139","internalIp":"10.30.20.139","internalHostname":"container1760","externalHostname":"tcook-demo-vmware-mysql-15","externalDomain":"demo.den.bertramlabs.com","externalFqdn":"tcook-demo-vmware-mysql-15.demo.den.bertramlabs.com","ports":[["index":0,"external":10007,"internal":3306,"displayName":"Db Port","primaryPort":true,"export":true,"visible":true,"loadBalance":false,"link":false,"exportName":null,"protocol":null,"code":"mysql.3306"]],"plan":["id":80,"code":"container-128","name":"128MB Memory, 1GB Storage"],"dateCreated":"2018-04-09T18:27:50+0000","lastUpdated":"2018-04-09T18:30:17+0000","statsEnabled":true,"status":"running","userStatus":"running","environmentPrefix":null,"stats":["ts":"2018-04-09T18:30:14+0000","dataSize":0,"indexSize":0,"maxStorage":1023303680,"usedStorage":141328384,"running":true,"userCpuUsage":0.0250333778,"systemCpuUsage":0.0083444593,"usedMemory":31850496,"maxMemory":134217728,"cacheMemory":13008896,"readIOPS":0,"writeIOPS":0,"totalIOPS":0,"netTxUsage":0,"netRxUsage":0],"runtimeInfo":[],"containerVersion":null,"repositoryImage":null,"planCategory":null,"hostname":"tcook-demo-vmware-mysql-15","domainName":null,"volumeCreated":true,"containerCreated":true,"maxStorage":1073741824,"maxMemory":134217728,"maxCores":null,"maxCpu":null,"availableActions":[]],["id":1759,"accountId":54,"instance":["id":4730,"name":"tcook-demo-vmware-docker-11"],"containerType":["id":168,"code":"docker-1.7","category":"docker","name":"Docker"],"containerTypeSet":["id":220,"code":"docker-1.7-set","category":null],"server":["id":9984,"name":"guacdocker"],"cloud":["id":2,"name":"VMware"],"name":"tcook-demo-vmware-docker-11_1759","ip":"10.30.20.139","internalIp":"10.30.20.139","internalHostname":"container1759","externalHostname":"tcook-demo-vmware-docker-11","externalDomain":"demo.den.bertramlabs.com","externalFqdn":"tcook-demo-vmware-docker-11.demo.den.bertramlabs.com","ports":[["index":0,"external":10006,"internal":8080,"export":true,"displayName":"web","link":false,"loadBalanceProtocol":"","loadBalance":false,"protocol":""]],"plan":["id":81,"code":"container-256","name":"256MB Memory, 3GB Storage"],"dateCreated":"2018-04-09T18:27:50+0000","lastUpdated":"2018-04-09T18:30:17+0000","statsEnabled":true,"status":"running","userStatus":"running","environmentPrefix":null,"stats":["ts":"2018-04-09T18:30:14+0000","maxStorage":3103539200,"usedStorage":4730880,"running":true,"userCpuUsage":0.083423709,"systemCpuUsage":0.0083423709,"usedMemory":46305280,"maxMemory":268435456,"cacheMemory":126976,"readIOPS":0,"writeIOPS":0,"totalIOPS":0,"netTxUsage":0,"netRxUsage":0],"runtimeInfo":[],"containerVersion":null,"repositoryImage":null,"planCategory":null,"hostname":"tcook-demo-vmware-docker-11","domainName":null,"volumeCreated":true,"containerCreated":true,"maxStorage":3221225472,"maxMemory":268435456,"maxCores":null,"maxCpu":null,"availableActions":[["code":"docker-remove-node","name":"Remove Node"]]]]] 
            echo morpheusApp.buildApp(morpheusUrl, postBody, "${bearer}")
        }
    }
  }

